<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="Scripts/jquery-1.6.4.js"></script>
    <script src="Scripts/jquery.signalR-2.1.2.js"></script>

    <script src="Scripts/rx.js"></script>
    <script src="Scripts/rx.async.js"></script>
    <script src="Scripts/rx.binding.js"></script>
    <script src="Scripts/rx.coincidence.js"></script>

    <script src="Scripts/relmah/relmah.js"></script>

    <script>
        $(function () {

            var r = relmah("http://localhost:9474/signalr"),
                $apps = $('#apps'),
                $groups = $('#groups');

            //streams

            var
                errors = r.getErrors(),
                apps = r.getApplications(),
                errorTypes = errors.groupBy(function (e) {
                    return e.Error.Type;
                });

            //subscriptions

            apps
                .filter(function (a) { return a.action === 'added'; })
                .subscribe(function (app) {
                    var name = app.name;
                    if (!$('#app-' + name).length)
                        $('<li/>')
                            .attr('id', 'app-' + name)
                            .append($('<p/>').text(name))
                            .append($('<ul/>').attr('id', 'errors-' + name))
                            .appendTo($apps);
                    $('#app-' + name).css({ 'background-color': 'yellow' });
                });

            apps
                .filter(function (a) { return a.action === 'removed'; })
                .subscribe(function (app) {
                    $('#app-' + app.name).css({ 'background-color': 'grey' });
                });

            errors
                .subscribe(function (e) {
                    $('<li/>')
                        .append($('<span/>').text(e.Error.Message))
                        .prependTo($('#errors-' + e.SourceId));
                });

            errorTypes
                .subscribe(function (type) {
                    var g = $('<li/>');
                    $groups.append(g);

                    type
                        .scan(0, function (a) { return a + 1; })
                        .subscribe(function (e) { g.text(type.key + ': ' + e); });
                });


            //startup
            $('#login').click(function () {
                $('#login').hide();
                $('#logout').show();
                $('#display').show();
                r.start().done(function () {
                    r.disconnected(function () {
                        $('#groups').empty();
                        $('#apps').empty();
                    });
                });
            });

            $('#logout').click(function () {
                $('#logout').hide();
                $('#login').show();
                $('#display').hide();
                r.stop();
            });
        });
    </script>
</head>
<body>
    <div>
        <button id="login">Login</button>
        <button id="logout" style="display: none">Logout</button>
    </div>
    <div id="display" style="display: none">
        <div>
            Error groups:
            <ul id="groups"></ul>
        </div>
        <div>
            Errors by source:
            <ul id="apps"></ul>
        </div>
    </div>
</body>
</html>
