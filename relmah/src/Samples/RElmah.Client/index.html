<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="Scripts/jquery-1.6.4.js"></script>
    <script src="Scripts/jquery.signalR-2.1.2.js"></script>
    <script src="Scripts/underscore.js"></script>
    <script>
        $(function() {
            var conn   = $.hubConnection("http://localhost:9474/signalr"),
                errors = conn.createHubProxy('relmah-errors');

            errors.on('error', function (e) {
                var cont = $('<li/>');

                $('<span/>')
                    .text(e.Error.Message)
                    .appendTo(cont);

                cont.prependTo($('#errors-' + e.SourceId));
            });

            errors.on('applications', function (subs, unsubs) {
                _.chain(subs)
                    .each(function(app) {
                        if (!$('#app-' + app).length) {
                            var cont = $('<li/>')
                                .attr('id', 'app-' + app);

                            $('<p/>')
                                .text(app)
                                .appendTo(cont);

                            $('<ul/>')
                                .attr('id', 'errors-' + app)
                                .appendTo(cont);

                            cont.appendTo($('#apps'));
                        }

                        $('#app-' + app).css({ 'background-color': 'yellow' });
                    });

                _.chain(unsubs)
                    .each(function (app) {
                        if ($('#app-' + app).length) {
                            $('#app-' + app).css({ 'background-color': 'grey' });
                        }
                    });

                errors.invoke('monitor', subs, unsubs);
            });

            $('#login').click(function () {
                conn.qs = { 'user': $('#user').val() };
                $('#user').attr("disabled", "disabled");
                $('#login').hide();

                conn.start();
            });
        });
    </script>
</head>
    <body>
        <input type="text" id="user"/><button id="login">Login</button>
        <ul id="apps"></ul>
    </body>
</html>
